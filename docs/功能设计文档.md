# 个人博客系统 - 功能设计文档

## 1. 系统架构设计

### 1.1 总体架构

```
┌─────────────────────────────────────────────────────────────┐
│                         用户浏览器                            │
└──────────────────────────┬──────────────────────────────────┘
                           │ HTTP/HTTPS
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                      阿里云服务器                            │
│  ┌────────────┐        ┌─────────────┐                      │
│  │   Nginx    │───────→│  FRP Server │                      │
│  │ 反向代理    │        │   (7000)    │                      │
│  └────────────┘        └─────────────┘                      │
└──────────────────────────┬──────────────────────────────────┘
                           │ FRP隧道
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                        本地服务器                            │
│  ┌──────────────┐     ┌──────────────┐   ┌──────────────┐  │
│  │  FRP Client  │     │ Spring Boot  │   │   Vue.js     │  │
│  │   (穿透)     │────→│  (8080)      │   │   (3000)     │  │
│  └──────────────┘     └──────┬───────┘   └──────────────┘  │
│                              │                              │
│                              ↓                              │
│                       ┌──────────────┐   ┌──────────────┐  │
│                       │    MySQL     │   │   Ollama AI  │  │
│                       │   (3306)     │   │   (11434)    │  │
│                       └──────────────┘   └──────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术架构层次

#### 1.2.1 前端架构
```
前端应用 (Vue 3)
├── 视图层 (Views)
│   ├── 页面组件
│   └── 路由管理
├── 组件层 (Components)
│   ├── 通用组件
│   └── 业务组件
├── 状态管理 (Pinia)
│   └── Store模块
├── 网络层 (Axios)
│   ├── API封装
│   └── 拦截器
└── 工具层 (Utils)
    ├── 格式化
    └── 验证
```

#### 1.2.2 后端架构
```
后端应用 (Spring Boot)
├── 控制层 (Controller)
│   ├── AuthController
│   ├── ArticleController
│   └── AIController
├── 业务层 (Service)
│   ├── UserService
│   ├── ArticleService
│   └── 接口实现
├── 数据访问层 (Mapper)
│   ├── UserMapper
│   ├── ArticleMapper
│   └── CommentMapper
├── 实体层 (Entity)
│   ├── User
│   ├── Article
│   └── Comment
└── 配置层 (Config)
    ├── Security
    ├── CORS
    └── MyBatis Plus
```

### 1.3 数据流转

```
用户操作 → 前端组件 → API调用 → 后端Controller → 
Service处理 → Mapper操作 → 数据库 → 
返回结果 → Service → Controller → 前端 → 页面更新
```

## 2. 核心模块设计

### 2.1 用户认证模块

#### 2.1.1 认证流程

```
用户登录
    ↓
验证用户名密码
    ↓
生成JWT Token
    ↓
返回Token和用户信息
    ↓
前端存储Token
    ↓
后续请求携带Token
    ↓
后端验证Token
    ↓
允许访问或拒绝
```

#### 2.1.2 JWT Token设计

**Token结构**：
- Header：算法类型（HS512）
- Payload：用户ID、过期时间
- Signature：签名

**Token生命周期**：
- 有效期：24小时
- 存储位置：localStorage
- 刷新机制：重新登录

#### 2.1.3 权限控制

**权限级别**：
- 游客：浏览文章、AI对话
- 普通用户：发布文章、编辑自己的文章
- 管理员：管理所有文章、用户（预留）

**权限检查点**：
- 前端路由守卫
- 后端接口拦截
- 数据库权限字段

### 2.2 文章管理模块

#### 2.2.1 数据模型

**Article实体**：
```java
- id: Long (主键)
- title: String (标题)
- content: Text (内容)
- summary: String (摘要)
- authorId: Long (作者ID)
- category: String (分类)
- tags: String (标签，逗号分隔)
- status: Integer (状态：0草稿 1已发布 2下线)
- viewCount: Integer (浏览量)
- createdAt: DateTime (创建时间)
- updatedAt: DateTime (更新时间)
- deleted: Integer (逻辑删除)
```

#### 2.2.2 业务流程

**创建文章**：
```
1. 用户输入文章信息
2. 前端验证（标题、内容必填）
3. 调用创建API
4. 后端验证用户身份
5. 保存到数据库
6. 返回成功结果
```

**查询文章列表**：
```
1. 接收查询参数（页码、大小、分类、关键词）
2. 构建查询条件
3. 执行分页查询
4. 返回结果集
```

**查看文章详情**：
```
1. 根据ID查询文章
2. 浏览量+1
3. Markdown渲染
4. 返回文章内容
```

#### 2.2.3 Markdown处理

**前端渲染**：
- 使用marked库解析Markdown
- highlight.js代码高亮
- 自定义样式

**支持特性**：
- 标题、段落
- 列表、引用
- 代码块、行内代码
- 链接、图片
- 表格

### 2.3 AI对话模块

#### 2.3.1 架构设计

```
前端 (AIChat.vue)
    ↓ HTTP POST
后端 (AIController)
    ↓ HTTP POST
本地AI服务 (vLLM)
    ↓ 生成响应
返回结果
```

#### 2.3.2 对话流程

```
1. 用户输入消息
2. 显示用户消息
3. 显示加载状态
4. 调用AI接口
5. 等待AI响应
6. 显示AI回复
7. 记录对话历史
```

#### 2.3.3 消息格式

**前端消息对象**：
```javascript
{
  role: 'user' | 'assistant',
  content: String,
  time: String
}
```

**API请求格式**：
```json
{
  "message": "用户输入的问题"
}
```

**API响应格式**：
```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "message": "AI的回复",
    "model": "llama2"
  }
}
```

### 2.4 内网穿透模块

#### 2.4.1 FRP配置

**服务端（阿里云）**：
- 监听端口：7000
- 管理端口：7500
- 代理端口：8080, 3000, 11434

**客户端（本地）**：
- 连接服务器
- 映射本地端口到远程端口
- 自动重连

#### 2.4.2 连接管理

**健康检查**：
- 心跳间隔：30秒
- 超时时间：90秒
- 自动重连

**状态监控**：
- 连接状态
- 流量统计
- 错误日志

## 3. 数据库设计

### 3.1 数据表设计

#### 3.1.1 用户表 (users)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| username | VARCHAR(50) | 用户名 | UNIQUE, NOT NULL |
| email | VARCHAR(100) | 邮箱 | UNIQUE, NOT NULL |
| password | VARCHAR(255) | 密码（加密） | NOT NULL |
| avatar | VARCHAR(255) | 头像URL | NULL |
| status | INT | 状态 | DEFAULT 1 |
| role | VARCHAR(20) | 角色 | DEFAULT 'user' |
| created_at | DATETIME | 创建时间 | NULL |
| updated_at | DATETIME | 更新时间 | NULL |
| deleted | INT | 逻辑删除 | DEFAULT 0 |

#### 3.1.2 文章表 (articles)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| title | VARCHAR(255) | 标题 | NOT NULL |
| content | TEXT | 内容 | NOT NULL |
| summary | VARCHAR(500) | 摘要 | NULL |
| author_id | BIGINT | 作者ID | NOT NULL, FK |
| category | VARCHAR(50) | 分类 | NULL |
| tags | VARCHAR(255) | 标签 | NULL |
| status | INT | 状态 | DEFAULT 1 |
| view_count | INT | 浏览量 | DEFAULT 0 |
| created_at | DATETIME | 创建时间 | NULL |
| updated_at | DATETIME | 更新时间 | NULL |
| deleted | INT | 逻辑删除 | DEFAULT 0 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_author_id (author_id)
- INDEX idx_category (category)
- INDEX idx_created_at (created_at)

#### 3.1.3 评论表 (comments)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| article_id | BIGINT | 文章ID | NOT NULL, FK |
| user_id | BIGINT | 用户ID | NOT NULL, FK |
| content | TEXT | 评论内容 | NOT NULL |
| parent_id | BIGINT | 父评论ID | NULL |
| status | INT | 状态 | DEFAULT 1 |
| created_at | DATETIME | 创建时间 | NULL |
| updated_at | DATETIME | 更新时间 | NULL |
| deleted | INT | 逻辑删除 | DEFAULT 0 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_article_id (article_id)
- INDEX idx_user_id (user_id)

### 3.2 数据关系

```
users (1) ────── (N) articles
users (1) ────── (N) comments
articles (1) ─── (N) comments
comments (1) ─── (N) comments (父子关系)
```

## 4. 接口设计

### 4.1 接口规范

**统一返回格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1234567890
}
```

**状态码**：
- 200：成功
- 400：请求错误
- 401：未认证
- 403：无权限
- 404：资源不存在
- 500：服务器错误

### 4.2 认证接口

#### 4.2.1 用户注册
```
POST /api/auth/register

Request:
{
  "username": "string",
  "email": "string",
  "password": "string"
}

Response:
{
  "code": 200,
  "message": "注册成功"
}
```

#### 4.2.2 用户登录
```
POST /api/auth/login

Request:
{
  "username": "string",
  "password": "string"
}

Response:
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "jwt_token",
    "userId": 1,
    "username": "string",
    "email": "string"
  }
}
```

### 4.3 文章接口

#### 4.3.1 获取文章列表
```
GET /api/articles?page=1&size=10&category=技术&keyword=搜索词

Response:
{
  "code": 200,
  "data": {
    "records": [...],
    "total": 100,
    "current": 1,
    "size": 10
  }
}
```

#### 4.3.2 获取文章详情
```
GET /api/articles/{id}

Response:
{
  "code": 200,
  "data": {
    "id": 1,
    "title": "string",
    "content": "string",
    ...
  }
}
```

#### 4.3.3 创建文章
```
POST /api/articles?userId=1
Headers: Authorization: Bearer {token}

Request:
{
  "title": "string",
  "content": "string",
  "summary": "string",
  "category": "string",
  "tags": "string",
  "status": 1
}

Response:
{
  "code": 200,
  "message": "文章创建成功",
  "data": {...}
}
```

### 4.4 AI接口

#### 4.4.1 AI对话
```
POST /api/ai/chat

Request:
{
  "message": "string"
}

Response:
{
  "code": 200,
  "message": "AI回复成功",
  "data": {
    "message": "string",
    "model": "llama2"
  }
}
```

## 5. 前端设计

### 5.1 页面结构

```
App.vue
├── Header.vue (导航栏)
├── Router View (页面内容)
│   ├── Home.vue (首页)
│   ├── Login.vue (登录)
│   ├── Register.vue (注册)
│   ├── ArticleList.vue (文章列表)
│   ├── ArticleDetail.vue (文章详情)
│   ├── CreateArticle.vue (创建文章)
│   └── AIChat.vue (AI对话)
└── Footer.vue (页脚)
```

### 5.2 路由设计

| 路径 | 组件 | 说明 | 权限 |
|------|------|------|------|
| / | Home | 首页 | 公开 |
| /login | Login | 登录 | 公开 |
| /register | Register | 注册 | 公开 |
| /articles | ArticleList | 文章列表 | 公开 |
| /article/:id | ArticleDetail | 文章详情 | 公开 |
| /create | CreateArticle | 创建文章 | 需登录 |
| /ai | AIChat | AI对话 | 公开 |

### 5.3 状态管理

**User Store**：
```javascript
{
  state: {
    token: '',
    userInfo: {}
  },
  getters: {
    isAuthenticated: Boolean,
    userId: Number,
    username: String
  },
  actions: {
    login(),
    logout(),
    setUserInfo()
  }
}
```

## 6. 安全设计

### 6.1 认证安全
- JWT Token认证
- Token过期机制
- 密码BCrypt加密

### 6.2 接口安全
- CORS跨域配置
- SQL注入防护
- XSS防护
- 权限验证

### 6.3 数据安全
- 敏感信息加密
- 逻辑删除
- 数据备份

## 7. 性能优化

### 7.1 前端优化
- 路由懒加载
- 组件按需加载
- 图片懒加载
- 资源压缩

### 7.2 后端优化
- 数据库索引
- 查询优化
- 连接池配置
- 缓存策略

### 7.3 网络优化
- Nginx反向代理
- Gzip压缩
- 静态资源CDN
- Keep-Alive连接

## 8. 监控与日志

### 8.1 日志记录
- 应用日志
- 访问日志
- 错误日志
- 性能日志

### 8.2 监控指标
- 系统资源
- 接口响应时间
- 错误率
- 并发量

## 9. 扩展性设计

### 9.1 功能扩展
- 插件机制
- 主题系统
- 多语言支持

### 9.2 性能扩展
- 负载均衡
- 分布式部署
- 微服务架构

## 10. 开发规范

### 10.1 代码规范
- Java：阿里巴巴Java开发手册
- JavaScript：ESLint规则
- 命名规范：驼峰命名

### 10.2 注释规范
- 类注释：说明用途
- 方法注释：参数、返回值、异常
- 关键逻辑注释

### 10.3 版本控制
- Git分支管理
- 提交信息规范
- 代码审查机制

