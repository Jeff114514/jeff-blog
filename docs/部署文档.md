# 个人博客系统 - 部署文档

## 1. 部署架构概述

### 1.1 部署拓扑

```
互联网用户
    ↓
阿里云服务器 (公网IP)
├── Nginx (80/443端口)
└── FRP Server (7000端口)
    ↓ (内网穿透)
本地服务器
├── FRP Client
├── Spring Boot后端 (8080端口)
├── Vue.js前端 (3000端口)
├── MySQL数据库 (3306端口)
└── Ollama AI服务 (11434端口)
```

### 1.2 部署方式

本项目支持两种部署方式：
1. **Docker部署**（推荐）：使用Docker Compose一键部署
2. **手动部署**：分别部署各个组件

## 2. 环境准备

### 2.1 阿里云服务器要求

**最低配置**：
- CPU: 1核
- 内存: 2GB
- 硬盘: 20GB
- 操作系统: Ubuntu 20.04 LTS 或 CentOS 7+
- 公网IP: 必须

**软件环境**：
- Docker 20.10+
- Docker Compose 1.29+
- Nginx（可选，用于非Docker部署）

### 2.2 本地服务器要求

**推荐配置**：
- CPU: 4核+
- 内存: 8GB+ (AI模型需要较大内存)
- 硬盘: 50GB+
- 操作系统: Windows 10/11 或 Linux
- 网络: 稳定的互联网连接

**软件环境**：
- Docker 20.10+ (推荐) 或
- JDK 11+
- Node.js 16+
- MySQL 8.0+
- vLLM (高性能AI推理服务)
- NVIDIA GPU（推荐）

## 3. 阿里云服务器部署

### 3.1 准备工作

#### 3.1.1 连接服务器

```bash
ssh root@your_server_ip
```

#### 3.1.2 更新系统

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS
sudo yum update -y
```

#### 3.1.3 安装Docker

```bash
# 安装Docker
curl -fsSL https://get.docker.com | sh

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 验证安装
docker --version
```

#### 3.1.4 安装Docker Compose

```bash
# 下载Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 添加执行权限
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker-compose --version
```

### 3.2 配置防火墙

```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 7000/tcp
sudo ufw allow 7500/tcp
sudo ufw enable

# CentOS (firewalld)
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=7000/tcp
sudo firewall-cmd --permanent --add-port=7500/tcp
sudo firewall-cmd --reload
```

**阿里云控制台安全组配置**：
1. 登录阿里云控制台
2. 进入ECS实例安全组
3. 添加入方向规则：
   - 端口80 (HTTP)
   - 端口443 (HTTPS)
   - 端口7000 (FRP)
   - 端口7500 (FRP管理)

### 3.3 部署服务

#### 3.3.1 上传配置文件

将`server`目录上传到服务器：

```bash
# 方式1: 使用scp
scp -r ./server root@your_server_ip:/root/blog-server

# 方式2: 使用git
ssh root@your_server_ip
cd /root
git clone your_repository_url blog-server
```

#### 3.3.2 修改配置

```bash
cd /root/blog-server

# 修改FRP配置
vim frp/frps.ini
# 修改token为强密码
# 修改dashboard_pwd为强密码

# 修改Nginx配置
vim nginx/blog.conf
# 修改server_name为你的域名
```

#### 3.3.3 启动服务

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

#### 3.3.4 验证部署

```bash
# 检查FRP服务
curl http://localhost:7500

# 检查Nginx
curl http://localhost

# 查看容器状态
docker ps
```

### 3.4 域名配置（可选）

#### 3.4.1 DNS解析

在域名提供商处添加A记录：
```
类型: A
主机记录: @ 或 www
记录值: 阿里云服务器公网IP
TTL: 600
```

#### 3.4.2 SSL证书配置（可选）

```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

修改nginx配置支持HTTPS：
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # 其他配置...
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

## 4. 本地服务器部署

### 4.1 Docker部署（推荐）

#### 4.1.1 安装Docker Desktop

**Windows**：
1. 下载Docker Desktop：https://www.docker.com/products/docker-desktop
2. 安装并启动
3. 确保WSL 2已启用

**Linux**：
```bash
# 参考阿里云服务器的Docker安装步骤
```

#### 4.1.2 安装vLLM AI服务

**Docker方式（推荐）**：
vLLM服务已在docker-compose.yml中配置，会自动启动。系统已配置为使用本地模型路径：`D:\code\llm\wyh\llm\Qwen3\Qwen3-4B-I-chat`

**使用本地模型**：
1. 确保本地模型文件存在于指定路径
2. 启动服务时会自动挂载本地模型目录到容器中
3. 容器内模型路径：`/models/Qwen3-4B-I-chat`

**手动安装方式**：

```bash
# 安装vLLM
pip install vllm

# 启动vLLM服务（使用本地模型）
python -m vllm.entrypoints.openai.api_server \
  --model /path/to/your/local/model \
  --host 0.0.0.0 \
  --port 8000 \
  --trust-remote-code
```

**本地模型准备**：
```bash
# 确保模型目录结构正确
# 模型路径：D:\code\llm\wyh\llm\Qwen3\Qwen3-4B-I-chat
# 目录应包含：
# - config.json
# - tokenizer.json 或 tokenizer.model
# - pytorch_model.bin 或 model.safetensors
# - 其他必要的模型文件
```

#### 4.1.3 修改配置

```bash
cd local

# 修改FRP客户端配置
# 编辑 frp/frpc.ini
# 修改server_addr为阿里云服务器IP
# 修改token与服务端一致

# 修改后端配置
# 编辑 backend/src/main/resources/application.yml
# 修改数据库密码
# 确认AI服务地址
```

#### 4.1.4 构建后端

```bash
cd local/backend

# 方式1: Maven构建
mvn clean package -DskipTests

# 方式2: 使用IDE (IntelliJ IDEA)
# 打开项目，点击Maven -> Lifecycle -> package
```

#### 4.1.5 启动服务

```bash
cd local

# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f backend
docker-compose logs -f frontend

# 查看服务状态
docker-compose ps
```

#### 4.1.6 验证部署

```bash
# 测试后端
curl http://localhost:8080/api/articles/list

# 测试前端
# 浏览器访问 http://localhost:3000

# 测试AI服务
curl http://localhost:11434/api/tags
```

### 4.2 手动部署

#### 4.2.1 数据库安装

**MySQL 8.0安装**：

**Windows**：
1. 下载MySQL安装包
2. 运行安装程序
3. 设置root密码

**Linux**：
```bash
# Ubuntu/Debian
sudo apt install mysql-server -y

# CentOS
sudo yum install mysql-server -y

# 启动MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

#### 4.2.2 vLLM AI服务安装

vLLM是一个高性能的大语言模型推理框架，支持多种开源模型。

**系统要求**：
- Python 3.8+
- NVIDIA GPU（推荐）
- CUDA 11.8+
- 至少8GB内存

**安装步骤**：

```bash
# 安装Python依赖
pip install vllm

# 或者使用Docker（推荐）
docker pull vllm/vllm-openai:latest
```

**下载模型**：
```bash
# 使用vLLM下载模型
python -c "
import torch
from transformers import AutoTokenizer, AutoModelForCausalLM

# 下载Llama-2-7b-chat模型
model_name = 'meta-llama/Llama-2-7b-chat-hf'
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForCausalLM.from_pretrained(model_name)
model.save_pretrained('./models/llama-2-7b-chat')
tokenizer.save_pretrained('./models/llama-2-7b-chat')
"
```

#### 4.2.3 创建数据库

```bash
# 登录MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE blog_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户（可选）
CREATE USER 'blog_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON blog_db.* TO 'blog_user'@'localhost';
FLUSH PRIVILEGES;
```

#### 4.2.3 初始化数据表

```sql
USE blog_db;

-- 用户表
CREATE TABLE `users` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `username` VARCHAR(50) NOT NULL UNIQUE,
  `email` VARCHAR(100) NOT NULL UNIQUE,
  `password` VARCHAR(255) NOT NULL,
  `avatar` VARCHAR(255),
  `status` INT DEFAULT 1,
  `role` VARCHAR(20) DEFAULT 'user',
  `created_at` DATETIME,
  `updated_at` DATETIME,
  `deleted` INT DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 文章表
CREATE TABLE `articles` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `title` VARCHAR(255) NOT NULL,
  `content` TEXT NOT NULL,
  `summary` VARCHAR(500),
  `author_id` BIGINT NOT NULL,
  `category` VARCHAR(50),
  `tags` VARCHAR(255),
  `status` INT DEFAULT 1,
  `view_count` INT DEFAULT 0,
  `created_at` DATETIME,
  `updated_at` DATETIME,
  `deleted` INT DEFAULT 0,
  PRIMARY KEY (`id`),
  KEY `idx_author_id` (`author_id`),
  KEY `idx_category` (`category`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 评论表
CREATE TABLE `comments` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `article_id` BIGINT NOT NULL,
  `user_id` BIGINT NOT NULL,
  `content` TEXT NOT NULL,
  `parent_id` BIGINT,
  `status` INT DEFAULT 1,
  `created_at` DATETIME,
  `updated_at` DATETIME,
  `deleted` INT DEFAULT 0,
  PRIMARY KEY (`id`),
  KEY `idx_article_id` (`article_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 4.2.4 部署后端

```bash
cd local/backend

# 构建项目
mvn clean package -DskipTests

# 运行
java -jar target/blog-backend-1.0.0.jar

# 或者后台运行
nohup java -jar target/blog-backend-1.0.0.jar > backend.log 2>&1 &
```

#### 4.2.5 部署前端

```bash
cd local/frontend

# 安装依赖
npm install

# 开发环境
npm run dev

# 生产环境构建
npm run build

# 使用Nginx部署生产构建
# 将dist目录内容复制到Nginx的html目录
```

#### 4.2.6 启动FRP客户端

**Windows**：
```powershell
cd local\frp
.\frpc.exe -c frpc.ini
```

**Linux**：
```bash
cd local/frp
./frpc -c frpc.ini

# 后台运行
nohup ./frpc -c frpc.ini > frpc.log 2>&1 &
```

## 5. 部署验证

### 5.1 功能测试

#### 5.1.1 访问测试

```bash
# 测试外网访问（使用公网IP或域名）
curl http://your-domain.com

# 测试API
curl http://your-domain.com/api/articles/list

# 测试FRP管理界面
http://your-server-ip:7500
```

#### 5.1.2 服务测试

1. **前端测试**：
   - 访问首页
   - 查看文章列表
   - 测试登录注册
   
2. **后端测试**：
   - 用户注册
   - 用户登录
   - 创建文章
   - 查看文章
   
3. **AI服务测试**：
   - 访问AI对话页面
   - 发送消息测试

### 5.2 性能测试

```bash
# 使用ab进行压力测试
ab -n 1000 -c 10 http://your-domain.com/

# 使用wrk进行测试
wrk -t12 -c400 -d30s http://your-domain.com/api/articles/list
```

## 6. 运维管理

### 6.1 日志管理

#### 6.1.1 查看日志

```bash
# Docker日志
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f frps

# 应用日志
tail -f local/backend/logs/blog-backend.log

# Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

#### 6.1.2 日志轮转

配置logrotate自动清理日志：

```bash
sudo vim /etc/logrotate.d/blog

# 添加配置
/root/blog-server/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
}
```

### 6.2 备份策略

#### 6.2.1 数据库备份

```bash
# 创建备份脚本
vim /root/backup_db.sh

#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/root/backups"
mkdir -p $BACKUP_DIR

mysqldump -u root -p'your_password' blog_db > $BACKUP_DIR/blog_db_$DATE.sql
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete

# 添加执行权限
chmod +x /root/backup_db.sh

# 添加定时任务
crontab -e
# 每天凌晨2点备份
0 2 * * * /root/backup_db.sh
```

#### 6.2.2 配置备份

```bash
# 备份配置文件
tar -czf config_backup_$(date +%Y%m%d).tar.gz \
  server/nginx/blog.conf \
  server/frp/frps.ini \
  local/backend/src/main/resources/application.yml
```

### 6.3 监控告警

#### 6.3.1 服务监控

```bash
# 创建监控脚本
vim /root/monitor.sh

#!/bin/bash
# 检查Docker容器状态
docker ps | grep -E "blog|frp" || echo "容器异常" | mail -s "告警" your@email.com

# 检查端口
nc -zv localhost 8080 || echo "后端服务异常"
nc -zv localhost 3000 || echo "前端服务异常"
```

#### 6.3.2 资源监控

```bash
# 安装htop
sudo apt install htop -y

# 查看系统资源
htop

# 查看Docker资源使用
docker stats
```

### 6.4 更新升级

#### 6.4.1 后端更新

```bash
# 1. 构建新版本
cd local/backend
mvn clean package -DskipTests

# 2. 停止服务
docker-compose stop backend

# 3. 更新镜像
docker-compose up -d --build backend

# 4. 验证
docker-compose logs -f backend
```

#### 6.4.2 前端更新

```bash
# 1. 构建新版本
cd local/frontend
npm run build

# 2. 更新
docker-compose stop frontend
docker-compose up -d --build frontend
```

#### 6.4.3 滚动更新（零停机）

```bash
# 使用Docker Compose的滚动更新
docker-compose up -d --no-deps --scale backend=2 backend
docker-compose up -d --no-deps --scale backend=1 backend
```

## 7. 故障排查

### 7.1 常见问题

#### 7.1.1 FRP连接失败

**问题**：FRP客户端无法连接服务器

**排查步骤**：
1. 检查服务器IP和端口是否正确
2. 检查防火墙是否开放7000端口
3. 检查token是否一致
4. 查看FRP服务端日志

```bash
docker-compose logs frps
```

#### 7.1.2 数据库连接失败

**问题**：后端无法连接数据库

**排查步骤**：
1. 检查数据库是否启动
2. 检查数据库用户名密码
3. 检查数据库端口
4. 查看后端日志

```bash
# 测试数据库连接
mysql -h localhost -u root -p blog_db
```

#### 7.1.3 AI服务无响应

**问题**：AI对话功能不可用

**排查步骤**：
1. 检查vLLM服务是否运行
2. 检查模型是否下载
3. 检查端口8000是否可访问
4. 查看vLLM服务日志

```bash
# 检查vLLM服务状态
curl http://localhost:8000/health

# 获取模型列表
curl http://localhost:8000/v1/models

# 测试聊天接口（使用本地Qwen模型）
curl -X POST http://localhost:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "Qwen3-4B-I-chat",
    "messages": [{"role": "user", "content": "你好"}],
    "max_tokens": 100
  }'
```

### 7.2 性能问题

#### 7.2.1 响应慢

**排查**：
- 检查数据库查询性能
- 检查网络延迟
- 检查服务器资源使用

**优化**：
- 添加数据库索引
- 启用查询缓存
- 优化SQL语句
- 增加服务器配置

#### 7.2.2 内存占用高

**排查**：
```bash
# 查看内存使用
free -h
docker stats

# 查看Java堆内存
jmap -heap <pid>
```

**优化**：
- 调整JVM参数
- 限制Docker容器内存
- 优化代码逻辑

## 8. 安全加固

### 8.1 系统安全

```bash
# 禁用root SSH登录
sudo vim /etc/ssh/sshd_config
# PermitRootLogin no

# 修改SSH端口
# Port 2222

# 重启SSH服务
sudo systemctl restart sshd

# 配置fail2ban防暴力破解
sudo apt install fail2ban -y
```

### 8.2 应用安全

- 定期更新依赖
- 使用强密码
- 启用HTTPS
- 配置Web应用防火墙（WAF）

### 8.3 数据安全

- 定期备份
- 加密敏感数据
- 限制数据库访问
- 日志审计

## 9. 参考资料

- [Docker官方文档](https://docs.docker.com/)
- [FRP文档](https://github.com/fatedier/frp)
- [Spring Boot文档](https://spring.io/projects/spring-boot)
- [Vue.js文档](https://vuejs.org/)
- [Nginx文档](https://nginx.org/en/docs/)
- [MySQL文档](https://dev.mysql.com/doc/)
- [Ollama文档](https://ollama.ai/)

## 附录

### A. 环境变量配置

```bash
# .env文件示例
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=blog_db
DB_USER=root
DB_PASSWORD=your_password

# JWT配置
JWT_SECRET=your_jwt_secret
JWT_EXPIRE=86400000

# AI服务配置
AI_URL=http://localhost:11434/api/generate
AI_MODEL=llama2

# FRP配置
FRP_SERVER_ADDR=your_server_ip
FRP_SERVER_PORT=7000
FRP_TOKEN=your_token
```

### B. 快速命令参考

```bash
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 重启服务
docker-compose restart

# 查看日志
docker-compose logs -f [service_name]

# 进入容器
docker exec -it <container_id> /bin/bash

# 备份数据库
mysqldump -u root -p blog_db > backup.sql

# 恢复数据库
mysql -u root -p blog_db < backup.sql
```

